# Spring Security 5.0.4

DelegatingFilterProxy -> 代理
SpringSecurityFilterChain(FilterChainProxy) -> 安全认证链
AuthenticationFilter ->
AuthenticationManager -> 配置认证用户信息
AuthenticationProvider -> 提供endpoint,如/oauth/authorize
UserDetails ->
AuthenticationToken ->
SecurityContextHolder

## 最简单的Spring Security认证 -- 基于http basic认证
## 最简单的Spring Security认证 -- Form Login

1. 自定义登陆过滤器
AbstractAuthenticationProcessingFilter
2. 自定义登陆provider
AuthenticationProvider


# Spring Security OAuth2
OAuth2 server = Security + AuthorizationEndpoint + TokenEndpoint
resource server = OAuth2AuthenticationPrrocessingFilter:加载Authentication

@EnableAuthorizationServer ->
ClientDetailsServiceConfigurer
AuthorizationServerSecurityConfigurer
AuthorizationServerEndpointConfigurer

---

# Authorization Server Configuration
## 基本使用
1. 注解：
```
@Configuration
@EnableAuthorizationServer
```
2. 三个configurer
* ClientDetailsServiceConfigurer: 配置自定义的clientDetailsService等
    clientDetailsService类主要是用来获取客户端信息， 包括客户端ID、客户端secret、授权类型等数据，
    在使用时可以自定义clientDetailsService类(继承clientDetailsService)，
    然后在ClientDetailsServiceConfigurer中使用withClientDetails()使用自定义的clientDetailsService;
* AuthorizationServerSecurityConfigurer: 在endpoint上加一下限制，比如允许表单验证等
* AuthorizationServerEndpointsConfigurer: 配置endpoint以及tokenService等（包含授权类型service的使用）
    自定义tokenService：
## 自定义开发
1. 自定义Provider
> Provider负责暴露OAuth2的


* SecurityFilters

---
# User Schema
create table users(
    username varchar_ignorecase(50) not null primary key,
    password varchar_ignorecase(50) not null,
    enabled boolean not null
);

create table authorities (
    username varchar_ignorecase(50) not null,
    authority varchar_ignorecase(50) not null,
    constraint fk_authorities_users foreign key(username) references users(username)
);

# Group Authorities
create table groups (
    id bigint generated by default as identity(start with 0) primary key,
    group_name varchar_ignorecase(50) not null
);

create table group_authorities (
    group_id bigint not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
    id bigint generated by default as identity(start with 0) primary key,
    username varchar(50) not null,
    group_id bigint not null,
    constraint fk_group_members_group foreign key(group_id) references groups(id)
);

# Persistent Login (Remember-Me) Schema
create table persistent_logins (
    username varchar(64) not null,
    series varchar(64) primary key,
    token varchar(64) not null,
    last_used timestamp not null
);

# ACL Schema
CREATE TABLE acl_sid (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    principal BOOLEAN NOT NULL,
    sid VARCHAR(100) NOT NULL,
    UNIQUE KEY unique_acl_sid (sid, principal)
) ENGINE=InnoDB;

CREATE TABLE acl_class (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    class VARCHAR(100) NOT NULL,
    UNIQUE KEY uk_acl_class (class)
) ENGINE=InnoDB;

CREATE TABLE acl_object_identity (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    object_id_class BIGINT UNSIGNED NOT NULL,
    object_id_identity VARCHAR(36) NOT NULL,
    parent_object BIGINT UNSIGNED,
    owner_sid BIGINT UNSIGNED,
    entries_inheriting BOOLEAN NOT NULL,
    UNIQUE KEY uk_acl_object_identity (object_id_class, object_id_identity),
    CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
    CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
    CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
) ENGINE=InnoDB;

CREATE TABLE acl_entry (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    acl_object_identity BIGINT UNSIGNED NOT NULL,
    ace_order INTEGER NOT NULL,
    sid BIGINT UNSIGNED NOT NULL,
    mask INTEGER UNSIGNED NOT NULL,
    granting BOOLEAN NOT NULL,
    audit_success BOOLEAN NOT NULL,
    audit_failure BOOLEAN NOT NULL,
    UNIQUE KEY unique_acl_entry (acl_object_identity, ace_order),
    CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
    CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
) ENGINE=InnoDB;


# Request
```
// authorization_code
// code
http://localhost:9992/oas/oauth/authorize?client_id=admin&redirect_uri=http%3A%2F%2Flocalhost%3A9992%2Foas%2Flogin&response_type=code&state=cSTsdK
// code->token
http://localhost:9992/oas/oauth/token?client_id=admin&client_secret=123456&redirect_uri=http%3A%2F%2Flocalhost%3A9992%2Foas%2Flogin&grant_type=authorization_code&code=ugMZFY&state=ZGFelm

// implicit, 浏览器中访问
http://localhost:9992/oas/oauth/authorize?client_id=admin&redirect_uri=http%3A%2F%2Flocalhost%3A9992%2Foas%2Flogin&response_type=token

// password
http://localhost:9992/oas/oauth/token?username=test&password=test&client_id=admin&client_secret=123456&grant_type=password

// client_credentials
http://localhost:9992/oas/oauth/token?client_id=admin&client_secret=123456&grant_type=client_credentials

// refresh_token
http://localhost:9992/oas/oauth/token?client_id=admin&client_secret=123456&grant_type=refresh_token
```